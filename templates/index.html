<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Diagnostics Chatbot - Unified Interface</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 600px;
      }

      .chat-header {
        background: linear-gradient(90deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 1.2em;
        font-weight: 500;
      }

      .user-session {
        background: #343a40;
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 30px;
        height: 30px;
        background: #007bff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.8em;
      }

      .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      .examples-section {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e1e5e9;
      }

      .examples-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
      }

      .example-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .example-button {
        background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 15px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .example-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.4;
      }

      .message.user .message-content {
        background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.bot .message-content {
        background: white;
        color: #333;
        border: 1px solid #e1e5e9;
        border-bottom-left-radius: 4px;
      }

      .diagnostic-result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
      }

      .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .code-id {
        font-family: "Courier New", monospace;
        font-weight: bold;
        font-size: 1.1em;
        color: #dc3545;
      }

      .priority {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .priority.high {
        background-color: #dc3545;
        color: white;
      }

      .priority.medium {
        background-color: #ffc107;
        color: #212529;
      }

      .priority.low {
        background-color: #28a745;
        color: white;
      }

      .confidence {
        color: #6c757d;
        font-size: 0.9em;
        margin-left: 10px;
      }

      .description {
        font-weight: bold;
        margin-bottom: 8px;
        color: #212529;
      }

      .causes-list {
        margin: 5px 0 0 20px;
        color: #495057;
      }

      .causes-list li {
        margin-bottom: 3px;
      }

      .loading {
        color: #6c757d;
        font-style: italic;
      }

      .loading-dots::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: "";
        }
        40% {
          content: ".";
        }
        60% {
          content: "..";
        }
        80%,
        100% {
          content: "...";
        }
      }

      .input-section {
        background: white;
        padding: 20px;
        border-top: 1px solid #e1e5e9;
      }

      .input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .input-wrapper {
        flex: 1;
        position: relative;
      }

      #user-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 25px;
        font-size: 1em;
        resize: none;
        min-height: 50px;
        max-height: 120px;
        transition: border-color 0.3s ease;
      }

      #user-input:focus {
        outline: none;
        border-color: #007bff;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      #send-button,
      #image-button {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      #send-button:hover,
      #image-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
      }

      #send-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
      }

      #image-button.active {
        background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
      }

      .image-preview {
        position: absolute;
        bottom: 60px;
        right: 0;
        background: white;
        border: 2px solid #007bff;
        border-radius: 10px;
        padding: 10px;
        transform: scale(0);
        transition: transform 0.3s ease;
        z-index: 10;
      }

      .image-preview.show {
        transform: scale(1);
      }

      .image-preview img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 5px;
      }

      #remove-image {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 0.8em;
      }

      #image-input {
        display: none;
      }

      .analysis-info {
        margin-top: 10px;
        padding: 8px 12px;
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        border-radius: 4px;
        font-size: 0.9em;
        color: #1565c0;
      }

      @media (max-width: 768px) {
        .main-container {
          margin: 10px;
          height: calc(100vh - 20px);
          border-radius: 10px;
        }

        .chat-container {
          height: 100%;
        }

        .example-buttons {
          justify-content: center;
        }

        .example-button {
          font-size: 0.8em;
          padding: 6px 10px;
        }

        .message-content {
          max-width: 85%;
        }

        .input-container {
          flex-direction: column;
          gap: 15px;
        }

        .action-buttons {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>🚗 Vehicle Diagnostics Chatbot</h1>
      <p>Smart diagnostics powered by NLP and AI technology</p>
    </div>

    <div class="main-container">
      <div class="chat-container">
        <div class="chat-header">
          🤖 Unified Vehicle Assistant - Ask anything or describe your vehicle
          problems
        </div>

        <!-- User Session Information -->
        {% if session.user %}
        <div class="user-session">
          <div class="user-info">
            <div class="user-avatar">
              {{ session.user.email[0].upper() }}
            </div>
            <span>Welcome, {{ session.user.get('firstName', 'User') }}!</span>
            {% if session.user.get('organization') %}
              <span style="opacity: 0.7;">• {{ session.user.organization }}</span>
            {% endif %}
          </div>
          <button class="logout-btn" onclick="handleLogout()">
            🚪 Sign Out
          </button>
        </div>
        {% endif %}

        <div class="examples-section">
          <div class="examples-title">💡 Try these examples:</div>
          <div class="example-buttons">
            <button
              class="example-button"
              onclick="sendExample('My engine is misfiring and running rough')"
            >
              Engine Misfire
            </button>
            <button
              class="example-button"
              onclick="sendExample('Check engine light is on')"
            >
              Check Engine Light
            </button>
            <button
              class="example-button"
              onclick="sendExample('Car won\'t start in cold weather')"
            >
              Starting Problems
            </button>
            <button
              class="example-button"
              onclick="sendExample('How often should I change my oil?')"
            >
              Maintenance Questions
            </button>
            <button
              class="example-button"
              onclick="sendExample('What does P0300 code mean?')"
            >
              OBD Code Lookup
            </button>
            <button
              class="example-button"
              onclick="sendExample('Best practices for winter driving')"
            >
              Driving Tips
            </button>
          </div>
        </div>

        <div id="chat-box" class="chat-messages">
          <!-- Messages will appear here -->
        </div>

        <div class="input-section">
          <div class="input-container">
            <div class="input-wrapper">
              <textarea
                id="user-input"
                placeholder="Describe your vehicle problem or ask any question..."
                rows="1"
              ></textarea>
              <div id="image-preview" class="image-preview">
                <img id="preview-img" src="" alt="Preview" />
                <button id="remove-image" type="button">✕</button>
              </div>
            </div>
            <div class="action-buttons">
              <button id="image-button" type="button" title="Upload image">
                📷
              </button>
              <button id="send-button" type="button" title="Send message">
                ➤
              </button>
            </div>
          </div>
          <input
            type="file"
            id="image-input"
            accept="image/*"
            style="display: none"
          />
        </div>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const imageInput = document.getElementById("image-input");
      const imageButton = document.getElementById("image-button");
      const imagePreview = document.getElementById("image-preview");
      const previewImg = document.getElementById("preview-img");
      const removeImageBtn = document.getElementById("remove-image");

      let selectedImage = null;

      // Auto-resize textarea
      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });

      // Image handling
      imageButton.addEventListener("click", () => {
        imageInput.click();
      });

      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          selectedImage = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImg.src = e.target.result;
            imagePreview.classList.add("show");
            imageButton.classList.add("active");
          };
          reader.readAsDataURL(file);
        }
      });

      removeImageBtn.addEventListener("click", clearImage);

      function clearImage() {
        selectedImage = null;
        imageInput.value = "";
        imagePreview.classList.remove("show");
        imageButton.classList.remove("active");
        previewImg.src = "";
      }

      function addMessage(content, isUser = false) {
        const message = document.createElement("div");
        message.className = `message ${isUser ? "user" : "bot"}`;

        const messageContent = document.createElement("div");
        messageContent.className = "message-content";

        if (typeof content === "string") {
          messageContent.innerHTML = content;
        } else {
          messageContent.appendChild(content);
        }

        message.appendChild(messageContent);
        chatBox.appendChild(message);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function createDiagnosticResult(match) {
        const result = document.createElement("div");
        result.className = "diagnostic-result";

        const priorityClass = match.priority.toLowerCase();

        result.innerHTML = `
                <div class="code-header">
                    <span class="code-id">${match.code}</span>
                    <div>
                        <span class="priority ${priorityClass}">${
          match.priority
        }</span>
                        <span class="confidence">Confidence: ${
                          match.confidence
                        }</span>
                    </div>
                </div>
                <div class="description">${match.description}</div>
                <div>
                    <strong>Common Causes:</strong>
                    <ul class="causes-list">
                        ${match.common_causes
                          .map((cause) => `<li>${cause}</li>`)
                          .join("")}
                    </ul>
                </div>
                ${
                  match.confirmation
                    ? `<div style="margin-top: 8px;"><strong>Additional Info:</strong> ${match.confirmation}</div>`
                    : ""
                }
            `;

        return result;
      }

      function showLoading() {
        addMessage(
          `<div class="loading">Analyzing your request<span class="loading-dots"></span></div>`
        );
      }

      function removeLoading() {
        const loadingMessages = chatBox.querySelectorAll(".loading");
        loadingMessages.forEach((msg) => {
          msg.closest(".message").remove();
        });
      }

      // Smart detection: determines whether to use NLP diagnosis or AI chat
      function shouldUseNLP(message, hasImage) {
        // Always use AI chat if there's an image
        if (hasImage) return false;

        // Check for diagnostic keywords that suggest specific vehicle problems
        const diagnosticKeywords = [
          "engine",
          "misfire",
          "idle",
          "rough",
          "stall",
          "knock",
          "ping",
          "oxygen",
          "sensor",
          "o2",
          "check engine",
          "cel",
          "code",
          "dtc",
          "transmission",
          "shift",
          "slip",
          "gear",
          "clutch",
          "brake",
          "abs",
          "pad",
          "rotor",
          "squeal",
          "suspension",
          "shock",
          "strut",
          "bounce",
          "exhaust",
          "smoke",
          "emission",
          "catalytic",
          "fuel",
          "gas",
          "mpg",
          "leak",
          "vapor",
          "cap",
          "coolant",
          "overheat",
          "temperature",
          "thermostat",
          "oil",
          "pressure",
          "leak",
          "consumption",
          "battery",
          "alternator",
          "starter",
          "electrical",
          "belt",
          "timing",
          "serpentine",
          "squeak",
          "vibration",
          "shake",
          "noise",
          "rattle",
        ];

        const messageLower = message.toLowerCase();
        const hasKeywords = diagnosticKeywords.some((keyword) =>
          messageLower.includes(keyword)
        );

        // Use NLP for diagnostic-specific queries
        return hasKeywords && message.length > 10; // Reasonable length for diagnostics
      }

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message && !selectedImage) return;

        // Add user message
        let userMessageContent = message;
        if (selectedImage) {
          userMessageContent += " [Image attached]";
        }

        if (userMessageContent) {
          addMessage(userMessageContent, true);
        }

        userInput.value = "";
        userInput.style.height = "auto";

        // Show loading
        showLoading();
        sendButton.disabled = true;

        try {
          let response;
          const useNLP = shouldUseNLP(message, selectedImage);

          if (useNLP && !selectedImage) {
            // Always use the combined NLP + Gemini AI approach
            const formData = new FormData();
            formData.append("message", message);
            if (selectedImage) {
              formData.append("image", selectedImage);
            }

            response = await fetch("/send_message", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();
            removeLoading();

            if (data.success) {
              if (data.matches && data.matches.length > 0) {
                // Create container for all results
                const resultsContainer = document.createElement("div");

                // Add summary with diagnostic icon
                const summary = document.createElement("div");
                summary.innerHTML = `<strong>🔍 Diagnostic Results: ${data.message}</strong>`;
                resultsContainer.appendChild(summary);

                // Add each diagnostic result
                data.matches.forEach((match) => {
                  resultsContainer.appendChild(createDiagnosticResult(match));
                });

                // Add analysis info if available
                if (
                  data.analysis &&
                  data.analysis.detected_symptoms.length > 0
                ) {
                  const analysisInfo = document.createElement("div");
                  analysisInfo.className = "analysis-info";
                  analysisInfo.style.marginTop = "10px";
                  analysisInfo.innerHTML = `
                                    <em>Detected symptoms: ${data.analysis.detected_symptoms.join(
                                      ", "
                                    )}</em>
                                `;
                  resultsContainer.appendChild(analysisInfo);
                }

                addMessage(resultsContainer);
              } else {
                // If NLP found nothing, fall back to AI chat
                await sendToAIChat(message, false);
              }
            } else {
              // If NLP failed, fall back to AI chat
              await sendToAIChat(message, false);
            }
          } else {
            // Use AI Chat for general questions, advice, or images
            await sendToAIChat(message, true);
          }
        } catch (error) {
          removeLoading();
          addMessage(`❌ Connection error: ${error.message}`);
        }

        sendButton.disabled = false;
      }

      async function sendToAIChat(message, showChatIcon) {
        try {
          const formData = new FormData();
          formData.append("message", message);
          if (selectedImage) {
            formData.append("image", selectedImage);
          }

          const response = await fetch("/send_message", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          removeLoading();

          const chatIcon = showChatIcon ? "🤖 " : "";
          addMessage(
            `${chatIcon}${
              data.reply || "Sorry, I could not process your request."
            }`
          );

          // Clear image after sending
          if (selectedImage) {
            clearImage();
          }
        } catch (error) {
          removeLoading();
          addMessage(`❌ Error: ${error.message}`);
        }
      }

      function sendExample(exampleText) {
        userInput.value = exampleText;
        sendMessage();
      }

      // Event listeners
      sendButton.addEventListener("click", sendMessage);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Welcome message
      window.addEventListener("load", () => {
        setTimeout(() => {
          addMessage(
            "👋 Welcome to the unified Vehicle Diagnostics Assistant! I can help with both specific diagnostic problems and general vehicle questions. Just type your message or upload an image, and I'll automatically route it to the best system for you."
          );
        }, 500);
      });

      // Logout function
      async function handleLogout() {
        if (confirm('Are you sure you want to sign out?')) {
          try {
            const response = await fetch('/auth/logout', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
              // Redirect to login page
              if (result.redirect) {
                window.location.href = result.redirect;
              } else {
                window.location.href = '/login';
              }
            } else {
              alert('Error signing out. Please try again.');
            }
          } catch (error) {
            console.error('Logout error:', error);
            alert('Network error. Please try again.');
          }
        }
      }
    </script>
  </body>
</html>
